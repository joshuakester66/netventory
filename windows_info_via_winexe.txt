#!/bin/bash

IPS=$1

CREDENTIAL_FILE="/home/jkester/scripts/.winexe_credentials"

for IP in $IPS
	do
		if ping -c 1 -W 1 -i 0.2 $IP &> /dev/null
			then
				DEVICE_HOSTNAME=
				DEVICE_MANUFACTURER=
				DEVICE_MODEL=
				USER_LOGON=
				LAST_USER=
				LAST_LOGON=
				LAST_LOGON=
				DEVICE_HOSTNAME=$(winexe-static-2 --authentication-file=$CREDENTIAL_FILE //$IP "hostname")
				if [[ -n "$DEVICE_HOSTNAME" ]]
					then
						DEVICE_MANUFACTURER=$(winexe-static-2 --authentication-file=$CREDENTIAL_FILE //$IP "wmic csproduct get vendor" | sed '/Vendor/d' | sed '/^[[:space:]]*$/d')
						DEVICE_MODEL=$(winexe-static-2 --authentication-file=$CREDENTIAL_FILE //$IP "wmic computersystem get model" | sed '/Model/d' | sed '/^[[:space:]]*$/d')
						USER_LOGON=$(winexe-static-2 --authentication-file=$CREDENTIAL_FILE //$IP "query user" | sed '/USERNAME/d')
						LAST_USER=$(echo "$USER_LOGON" | egrep --color=never -o '^(\s+)?[0-9A-Za-z\.]+' | sed 's/\s//g')
						LAST_LOGON=$(echo "$USER_LOGON" | egrep --color=never -o '[0-9]{2}\/[0-9]{2}\/[0-9]{4}\s[0-9]{2}\:[0-9]{2}')
						if [[ -n "$LAST_LOGON" ]]
							then
								LAST_LOGON=$(date -d "${LAST_LOGON}" +"%Y-%m-%d %H:%M:%S")
						fi
					else
						echo "Device is not responding to winexe"
				fi
				echo "Device: $IP"
				echo "Hostname: $DEVICE_HOSTNAME"
				echo "Manufacturer: $DEVICE_MANUFACTURER"
				echo "Model: $DEVICE_MODEL"
				echo "Last User: $LAST_USER"
				echo "Last Logon: $LAST_LOGON"
				echo
			else
				echo "$IP is unreachable"
		fi
done



exit
